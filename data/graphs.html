<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" type="text/css" href="style.css">
  <title>Silvia Control</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript" src="table.js"></script>
  <script type="text/javascript">
    google.charts.load('current', {'packages':['line', 'corechart']});
    google.charts.setOnLoadCallback(drawChart);
    
    function drawChart() {
      var chartDiv = document.getElementById('chart_div');
      var classicChart = new google.visualization.LineChart(chartDiv);
      
      var obj_data_table = new google.visualization.DataTable();
      obj_data_table.addColumn('number', "Time");
      obj_data_table.addColumn('number', "Temperature");
      obj_data_table.addColumn('number', "TargetPWM");
      
      var xhr=new XMLHttpRequest();
      xhr.open("GET","data.csv");
      xhr.onload= function() {
        var i_row_start = 3;
        
        var str_buf = xhr.responseText;
        lst_data = str_buf.split(/\r?\n/g);
        
        for (let i_row = i_row_start; i_row<lst_data.length; i_row++){
          var lst_line = lst_data[i_row].split(",")
          var f_time = parseFloat(lst_line[0]);
          var f_temp  = parseFloat(lst_line[1]);
          var f_pwm  = parseFloat(lst_line[6]);
          obj_data_table.addRow([f_time, f_temp, f_pwm]);
        }
        
        var classicOptions = {
          title: 'Temperature and Target PWM',
          // Gives each series an axis that matches the vAxes number below.
          series: {
            0: {targetAxisIndex: 0},
            1: {targetAxisIndex: 1}
          },
          vAxes: {
            // Adds titles to each axis.
            0: {title: 'Temperature (Celsius)', 
            viewWindow: { max: 150, min: 20 }},
            1: {title: 'Target PWM ([0-255])',
            viewWindow: { max: 255, min: 0 }},
          },
          legend: {position: 'bottom'},
          hAxis: {
            // ticks: []
            title: 'Time (s)',
          },
        };
        classicChart.draw(obj_data_table, classicOptions);
      }
      xhr.send();
    }

    setInterval(drawChart, 3000);
</script>

</head>
<body>

<div class="header">
  <h1>Silvia Control</h1>
  <p>A simple <b>web interface</b> to control Rancilio Silvia espresso machine.</p>
</div>

<div class="navbar">
  <a href="/">Home</a>
  <a href="graphs" class="active">Graphs</a>
  <a href="#">Settings</a>
  <a href="#" class="right">About</a>
</div>

<div class="row">
  <div class="main">
    <h2>Control Board</h2>
    <h3>Status</h3>
    <div id="table_div"></div>
    <h3>Sensor Graphs</h3>
    <div id="chart_div", style="width:50%;height:500px"></div>
  </div>
</div>

<div class="footer">
  <h5>Footer</h5>
</div>

</body>
</html>
